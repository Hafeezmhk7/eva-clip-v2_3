2025-08-01 22:58:03,291 - INFO - üöÄ Clean BLIP3-o CLIP Reproduction Training
2025-08-01 22:58:03,292 - INFO - ============================================================
2025-08-01 22:58:03,293 - INFO - üìã Task: Reproduce CLIP embeddings from EVA embeddings
2025-08-01 22:58:03,293 - INFO - üß† Model: BLIP3-o DiT with 3D RoPE and Sandwich Normalization
2025-08-01 22:58:03,293 - INFO - üåä Method: Rectified Flow Matching
2025-08-01 22:58:03,293 - INFO - üéØ Target: CLIP embeddings [B, N, 1024]
2025-08-01 22:58:03,293 - INFO - üéÆ Conditioning: EVA embeddings [B, N, 4096]
2025-08-01 22:58:03,293 - INFO - ============================================================
2025-08-01 22:58:03,294 - INFO - Configuration:
2025-08-01 22:58:03,294 - INFO -   Model size: base
2025-08-01 22:58:03,294 - INFO -   Training mode: patch_only
2025-08-01 22:58:03,294 - INFO -   Embeddings dir: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-08-01 22:58:03,294 - INFO -   Output dir: ./checkpoints/blip3o_clean_20250801_225801
2025-08-01 22:58:03,294 - INFO -   Learning rate: 0.0005
2025-08-01 22:58:03,294 - INFO -   Batch size: 128
2025-08-01 22:58:03,294 - INFO -   Epochs: 10
2025-08-01 22:58:03,294 - INFO -   Max shards: 5
2025-08-01 22:58:03,734 - INFO - Using GPU: NVIDIA H100
2025-08-01 22:58:03,734 - INFO - GPU Memory: 100.0 GB
2025-08-01 22:58:03,734 - INFO - PyTorch version: 2.7.1+cu126
2025-08-01 22:58:03,734 - INFO - ‚úÖ Environment check passed
2025-08-01 22:58:03,734 - INFO - ‚úÖ Output directory ready: checkpoints/blip3o_clean_20250801_225801
2025-08-01 22:58:03,734 - INFO - üèóÔ∏è Creating model...
2025-08-01 22:58:06,129 - INFO - ‚úÖ CLIP DiT model loaded successfully
2025-08-01 22:58:06,130 - INFO - ‚úÖ Flow matching loss loaded successfully
2025-08-01 22:58:06,834 - INFO - ‚úÖ CLIP trainer loaded successfully
2025-08-01 22:58:06,835 - INFO - ‚úÖ CLIP datasets loaded successfully
2025-08-01 22:58:06,837 - INFO - ‚úÖ Configuration loaded successfully
2025-08-01 22:58:06,837 - INFO - üéâ All CLIP reproduction components loaded successfully!
2025-08-01 22:58:06,837 - INFO - üéâ Clean BLIP3-o CLIP reproduction modules fully initialized!
2025-08-01 22:58:06,837 - INFO - üéØ Ready for EVA ‚Üí CLIP reproduction training
2025-08-01 22:58:08,607 - INFO - CORRECTED BLIP3-o CLIP DiT model with SwiGLU initialized: 221,027,584 parameters
2025-08-01 22:58:08,607 - INFO -   ‚úÖ 3D RoPE: True
2025-08-01 22:58:08,607 - INFO -   ‚úÖ Sandwich Normalization: True
2025-08-01 22:58:08,607 - INFO -   ‚úÖ Grouped-Query Attention: 12/4 heads
2025-08-01 22:58:08,607 - INFO -   ‚úÖ SwiGLU activation: Now properly implemented!
2025-08-01 22:58:08,842 - INFO - Model created with 221,027,584 parameters
2025-08-01 22:58:08,843 - INFO -   Model size: base
2025-08-01 22:58:08,843 - INFO -   Training mode: patch_only
2025-08-01 22:58:08,843 - INFO -   3D RoPE: Enabled
2025-08-01 22:58:08,843 - INFO -   Sandwich Norm: Enabled
2025-08-01 22:58:08,843 - INFO - üåä Creating loss function...
2025-08-01 22:58:08,843 - INFO - Clean CLIP Flow Matching Loss initialized:
2025-08-01 22:58:08,843 - INFO -   Prediction type: velocity
2025-08-01 22:58:08,843 - INFO -   Flow type: rectified
2025-08-01 22:58:08,843 - INFO - Loss function created:
2025-08-01 22:58:08,843 - INFO -   Prediction type: velocity
2025-08-01 22:58:08,843 - INFO -   Flow type: rectified
2025-08-01 22:58:08,843 - INFO - üìä Creating dataloaders...
2025-08-01 22:58:08,843 - INFO - Loading embeddings from: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-08-01 22:58:08,844 - INFO - Found 35 .pkl files in embeddings directory
2025-08-01 22:58:08,844 - INFO - Creating clean CLIP reproduction dataloaders:
2025-08-01 22:58:08,844 - INFO -   Target: CLIP embeddings [B, N, 1024]
2025-08-01 22:58:08,844 - INFO -   Conditioning: EVA embeddings [B, N, 4096]
2025-08-01 22:58:08,845 - INFO -   Noise: Standard Gaussian
2025-08-01 22:58:08,884 - INFO - Loaded manifest: 35 shards, 91,333 samples
2025-08-01 22:58:08,884 - INFO - Found 35 files with pattern: embeddings_shard_*_patch_only.pkl
2025-08-01 22:58:08,902 - INFO - Prepared 5 shard files
2025-08-01 22:58:08,902 - INFO - Using manifest for length estimation: 13,047 samples
2025-08-01 22:58:08,902 - INFO - Clean CLIP Reproduction Dataset initialized:
2025-08-01 22:58:08,902 - INFO -   Directory: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-08-01 22:58:08,902 - INFO -   Mode: patch_only (256 tokens)
2025-08-01 22:58:08,902 - INFO -   TARGET: CLIP embeddings [B, N, 1024]
2025-08-01 22:58:08,902 - INFO -   CONDITIONING: EVA embeddings [B, N, 4096]
2025-08-01 22:58:08,902 - INFO -   Shards: 5
2025-08-01 22:58:08,903 - INFO - Loaded manifest: 35 shards, 91,333 samples
2025-08-01 22:58:08,903 - INFO - Found 35 files with pattern: embeddings_shard_*_patch_only.pkl
2025-08-01 22:58:08,903 - INFO - Prepared 5 shard files
2025-08-01 22:58:08,903 - INFO - Using manifest for length estimation: 13,047 samples
2025-08-01 22:58:08,903 - INFO - Clean CLIP Reproduction Dataset initialized:
2025-08-01 22:58:08,903 - INFO -   Directory: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-08-01 22:58:08,903 - INFO -   Mode: patch_only (256 tokens)
2025-08-01 22:58:08,903 - INFO -   TARGET: CLIP embeddings [B, N, 1024]
2025-08-01 22:58:08,903 - INFO -   CONDITIONING: EVA embeddings [B, N, 4096]
2025-08-01 22:58:08,903 - INFO -   Shards: 5
2025-08-01 22:58:08,903 - INFO - Clean CLIP reproduction dataloaders created successfully
2025-08-01 22:58:08,903 - INFO -   Training dataset length: 13,047
2025-08-01 22:58:08,903 - INFO -   Evaluation dataset length: 13,047
2025-08-01 22:58:08,903 - INFO - Dataloaders created successfully:
2025-08-01 22:58:08,903 - INFO -   Training mode: patch_only
2025-08-01 22:58:08,903 - INFO -   Batch size: 128
2025-08-01 22:58:08,903 - INFO -   Max shards: 5
2025-08-01 22:58:14,036 - INFO - ‚úÖ Dataloader test successful:
2025-08-01 22:58:14,039 - INFO -   Batch size: 128
2025-08-01 22:58:14,039 - INFO -   CLIP embeddings shape: torch.Size([128, 256, 1024])
2025-08-01 22:58:14,039 - INFO -   EVA embeddings shape: torch.Size([128, 256, 4096])
2025-08-01 22:58:14,039 - INFO - üèÉ Creating trainer...
2025-08-01 22:58:14,043 - INFO - Got exact dataloader length: 101
2025-08-01 22:58:14,044 - INFO - Optimizer and scheduler setup complete
2025-08-01 22:58:14,044 - INFO -   Total estimated steps: 1010
2025-08-01 22:58:14,044 - INFO -   Warmup steps: 500
2025-08-01 22:58:14,044 - INFO - Clean BLIP3-o CLIP Trainer initialized
2025-08-01 22:58:14,044 - INFO -   Device: cuda
2025-08-01 22:58:14,045 - INFO -   Parameters: 221,027,584
2025-08-01 22:58:14,045 - INFO - Trainer created successfully:
2025-08-01 22:58:14,045 - INFO -   Evaluation: Every 100 steps
2025-08-01 22:58:14,045 - INFO -   WandB enabled: False
2025-08-01 22:58:14,045 - INFO - üíæ Saving experiment configuration...
2025-08-01 22:58:14,049 - INFO - ‚úÖ Configuration saved to checkpoints/blip3o_clean_20250801_225801/experiment_config.json
2025-08-01 22:58:14,049 - INFO - 
üöÄ Starting clean BLIP3-o training...
2025-08-01 22:58:14,049 - INFO - ============================================================
2025-08-01 22:58:14,049 - INFO - üöÄ Starting clean BLIP3-o training...
2025-08-01 22:58:14,050 - INFO -   Model parameters: 221,027,584
2025-08-01 22:58:14,052 - INFO - Starting epoch 1/10
2025-08-01 22:58:27,643 - INFO - Step 10: Loss=1.770568, VelSim=0.3203, GradNorm=23692.227, LR=5.90e-05
2025-08-01 22:58:36,525 - INFO - Step 20: Loss=1.707386, VelSim=0.3599, GradNorm=12562.313, LR=6.80e-05
2025-08-01 22:58:50,288 - INFO - Step 30: Loss=1.673051, VelSim=0.3641, GradNorm=20192.325, LR=7.70e-05
2025-08-01 22:58:59,174 - INFO - Step 40: Loss=1.646918, VelSim=0.3693, GradNorm=44092.804, LR=8.60e-05
2025-08-01 22:59:12,707 - INFO - Step 50: Loss=1.579008, VelSim=0.3759, GradNorm=15721.677, LR=9.50e-05
2025-08-01 22:59:21,595 - INFO - Step 60: Loss=1.557677, VelSim=0.3672, GradNorm=31373.106, LR=1.04e-04
2025-08-01 22:59:35,577 - INFO - Step 70: Loss=1.456906, VelSim=0.3682, GradNorm=38773.909, LR=1.13e-04
2025-08-01 22:59:44,465 - INFO - Step 80: Loss=1.405637, VelSim=0.3587, GradNorm=58259.498, LR=1.22e-04
2025-08-01 22:59:58,670 - INFO - Step 90: Loss=1.394138, VelSim=0.3685, GradNorm=46553.310, LR=1.31e-04
2025-08-01 23:00:07,557 - INFO - Step 100: Loss=1.377000, VelSim=0.3770, GradNorm=31377.863, LR=1.40e-04
2025-08-01 23:00:07,558 - INFO - Running evaluation at step 100...
2025-08-01 23:00:07,558 - INFO - Starting evaluation with 100 samples
2025-08-01 23:00:31,393 - INFO - ‚úÖ Evaluation completed: 128 samples, similarity: 0.2374
2025-08-01 23:00:31,395 - INFO - ‚úÖ Evaluation results:
2025-08-01 23:00:31,395 - INFO -   CLIP similarity: 0.2374
2025-08-01 23:00:33,346 - INFO - Iteration completed: 13151 samples processed
2025-08-01 23:00:33,346 - INFO - Epoch 1 completed: 102 batches processed
2025-08-01 23:00:33,360 - INFO - Epoch 1 completed:
2025-08-01 23:00:33,361 - INFO -   Average loss: 1.581035
2025-08-01 23:00:33,361 - INFO -   Best loss: 1.353555
2025-08-01 23:00:33,361 - INFO -   Best similarity: 0.3879
2025-08-01 23:00:33,361 - INFO -   Steps in epoch: 102
2025-08-01 23:00:33,361 - INFO -   Epoch time: 139.3s
2025-08-01 23:00:33,361 - INFO - Starting epoch 2/10
2025-08-01 23:00:45,075 - INFO - Step 110: Loss=1.375505, VelSim=0.3764, GradNorm=37532.530, LR=1.49e-04
2025-08-01 23:00:53,960 - INFO - Step 120: Loss=1.358104, VelSim=0.3773, GradNorm=36372.757, LR=1.58e-04
2025-08-01 23:01:07,341 - INFO - Step 130: Loss=1.353469, VelSim=0.3811, GradNorm=30070.172, LR=1.67e-04
2025-08-01 23:01:16,222 - INFO - Step 140: Loss=1.348284, VelSim=0.3848, GradNorm=46182.384, LR=1.76e-04
2025-08-01 23:01:29,789 - INFO - Step 150: Loss=1.376859, VelSim=0.3790, GradNorm=45631.059, LR=1.85e-04
2025-08-01 23:01:38,653 - INFO - Step 160: Loss=1.352241, VelSim=0.3861, GradNorm=27528.698, LR=1.94e-04
2025-08-01 23:01:52,338 - INFO - Step 170: Loss=1.355052, VelSim=0.3847, GradNorm=26310.416, LR=2.03e-04
2025-08-01 23:02:01,204 - INFO - Step 180: Loss=1.341762, VelSim=0.3897, GradNorm=40632.674, LR=2.12e-04
2025-08-01 23:02:14,698 - INFO - Step 190: Loss=1.328300, VelSim=0.3945, GradNorm=31160.261, LR=2.21e-04
2025-08-01 23:02:23,586 - INFO - Step 200: Loss=1.331076, VelSim=0.3953, GradNorm=25420.427, LR=2.30e-04
2025-08-01 23:02:23,587 - INFO - Running evaluation at step 200...
2025-08-01 23:02:23,587 - INFO - Starting evaluation with 100 samples
2025-08-01 23:02:47,177 - INFO - ‚úÖ Evaluation completed: 128 samples, similarity: 0.2583
2025-08-01 23:02:47,178 - INFO - ‚úÖ Evaluation results:
2025-08-01 23:02:47,178 - INFO -   CLIP similarity: 0.2583
2025-08-01 23:02:50,871 - INFO - Iteration completed: 13151 samples processed
2025-08-01 23:02:50,871 - INFO - Epoch 2 completed: 102 batches processed
2025-08-01 23:02:50,885 - INFO - Epoch 2 completed:
2025-08-01 23:02:50,886 - INFO -   Average loss: 1.352842
2025-08-01 23:02:50,886 - INFO -   Best loss: 1.321087
2025-08-01 23:02:50,886 - INFO -   Best similarity: 0.4026
2025-08-01 23:02:50,886 - INFO -   Steps in epoch: 102
2025-08-01 23:02:50,886 - INFO -   Epoch time: 137.5s
2025-08-01 23:02:50,886 - INFO - Starting epoch 3/10
2025-08-01 23:03:00,692 - INFO - Step 210: Loss=1.332233, VelSim=0.3951, GradNorm=21996.002, LR=2.39e-04
2025-08-01 23:03:09,556 - INFO - Step 220: Loss=1.321571, VelSim=0.4046, GradNorm=23334.648, LR=2.48e-04
2025-08-01 23:03:23,256 - INFO - Step 230: Loss=1.329405, VelSim=0.4033, GradNorm=23549.874, LR=2.57e-04
2025-08-01 23:03:32,127 - INFO - Step 240: Loss=1.306949, VelSim=0.4130, GradNorm=27581.248, LR=2.66e-04
2025-08-01 23:03:46,425 - INFO - Step 250: Loss=1.309587, VelSim=0.4072, GradNorm=25564.337, LR=2.75e-04
2025-08-01 23:03:55,297 - INFO - Step 260: Loss=1.303609, VelSim=0.4220, GradNorm=32559.884, LR=2.84e-04
2025-08-01 23:04:08,973 - INFO - Step 270: Loss=1.327422, VelSim=0.4132, GradNorm=36099.071, LR=2.93e-04
2025-08-01 23:04:17,836 - INFO - Step 280: Loss=1.298963, VelSim=0.4172, GradNorm=26742.955, LR=3.02e-04
2025-08-01 23:04:31,554 - INFO - Step 290: Loss=1.290157, VelSim=0.4301, GradNorm=29687.138, LR=3.11e-04
2025-08-01 23:04:40,419 - INFO - Step 300: Loss=1.292562, VelSim=0.4293, GradNorm=28836.511, LR=3.20e-04
2025-08-01 23:04:40,420 - INFO - Running evaluation at step 300...
2025-08-01 23:04:40,420 - INFO - Starting evaluation with 100 samples
2025-08-01 23:05:04,854 - INFO - ‚úÖ Evaluation completed: 128 samples, similarity: 0.2615
2025-08-01 23:05:04,856 - INFO - ‚úÖ Evaluation results:
2025-08-01 23:05:04,856 - INFO -   CLIP similarity: 0.2615
2025-08-01 23:05:10,320 - INFO - Iteration completed: 13151 samples processed
2025-08-01 23:05:10,323 - INFO - Epoch 3 completed: 102 batches processed
2025-08-01 23:05:10,337 - INFO - Epoch 3 completed:
2025-08-01 23:05:10,337 - INFO -   Average loss: 1.310789
2025-08-01 23:05:10,337 - INFO -   Best loss: 1.277855
2025-08-01 23:05:10,337 - INFO -   Best similarity: 0.4363
2025-08-01 23:05:10,338 - INFO -   Steps in epoch: 102
2025-08-01 23:05:10,338 - INFO -   Epoch time: 139.5s
2025-08-01 23:05:10,338 - INFO - Starting epoch 4/10
2025-08-01 23:05:18,735 - INFO - Step 310: Loss=1.287536, VelSim=0.4312, GradNorm=26342.284, LR=3.29e-04
2025-08-01 23:05:27,596 - INFO - Step 320: Loss=1.279588, VelSim=0.4359, GradNorm=25744.558, LR=3.38e-04
2025-08-01 23:05:40,960 - INFO - Step 330: Loss=1.267448, VelSim=0.4419, GradNorm=25834.830, LR=3.47e-04
2025-08-01 23:05:49,827 - INFO - Step 340: Loss=1.268779, VelSim=0.4379, GradNorm=29461.532, LR=3.56e-04
2025-08-01 23:06:03,265 - INFO - Step 350: Loss=1.268573, VelSim=0.4411, GradNorm=36231.622, LR=3.65e-04
2025-08-01 23:06:12,149 - INFO - Step 360: Loss=1.259275, VelSim=0.4527, GradNorm=21905.776, LR=3.74e-04
2025-08-01 23:06:25,988 - INFO - Step 370: Loss=1.282510, VelSim=0.4518, GradNorm=39795.817, LR=3.83e-04
