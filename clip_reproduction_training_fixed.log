2025-07-28 15:57:47,497 - INFO - üöÄ FIXED: CLIP Reproduction with Consistent Evaluation
2025-07-28 15:57:47,499 - INFO - ================================================================================
2025-07-28 15:57:47,499 - INFO - üîß CRITICAL FIXES APPLIED:
2025-07-28 15:57:47,499 - INFO -   1. ‚úÖ Evaluation uses subset of training data
2025-07-28 15:57:47,499 - INFO -   2. ‚úÖ Extensive data statistics logging
2025-07-28 15:57:47,499 - INFO -   3. ‚úÖ Early detection of norm mismatches
2025-07-28 15:57:47,499 - INFO -   4. ‚úÖ Validation of training/evaluation consistency
2025-07-28 15:57:47,499 - INFO -   5. ‚úÖ No hidden normalization differences
2025-07-28 15:57:47,499 - INFO - ================================================================================
2025-07-28 15:57:47,499 - INFO - üéØ PROBLEM ADDRESSED:
2025-07-28 15:57:47,499 - INFO -   ‚Ä¢ Training data CLIP norm: ~40 (model learns this)
2025-07-28 15:57:47,499 - INFO -   ‚Ä¢ Evaluation data CLIP norm: ~26 (different source!)
2025-07-28 15:57:47,499 - INFO -   ‚Ä¢ Model predicts norm ~40 but evaluated on norm ~26
2025-07-28 15:57:47,499 - INFO -   ‚Ä¢ Result: Low CLIP similarity due to norm mismatch
2025-07-28 15:57:47,499 - INFO - ================================================================================
2025-07-28 15:57:47,499 - INFO - üîß SOLUTION:
2025-07-28 15:57:47,499 - INFO -   ‚Ä¢ Use first 100 samples from training data for evaluation
2025-07-28 15:57:47,499 - INFO -   ‚Ä¢ Validate that train/eval norms are consistent
2025-07-28 15:57:47,499 - INFO -   ‚Ä¢ Log detailed statistics to catch any mismatches
2025-07-28 15:57:47,499 - INFO -   ‚Ä¢ No separate evaluation dataset preprocessing
2025-07-28 15:57:47,499 - INFO - ================================================================================
2025-07-28 15:57:47,500 - INFO - EXPERIMENT DETAILS:
2025-07-28 15:57:47,500 - INFO -   üìã Task: Reproduce clean CLIP embeddings from EVA embeddings
2025-07-28 15:57:47,500 - INFO -   üß† Model: BLIP3-o DiT with advanced architecture features
2025-07-28 15:57:47,500 - INFO -   üéØ Target: CLIP embeddings [B, N, 1024]
2025-07-28 15:57:47,500 - INFO -   üéÆ Conditioning: EVA embeddings [B, N, 4096]
2025-07-28 15:57:47,500 - INFO -   üåä Method: Rectified Flow Matching
2025-07-28 15:57:47,500 - INFO -   üö´ Normalization: MINIMAL (only for evaluation similarity)
2025-07-28 15:57:47,500 - INFO - ================================================================================
2025-07-28 15:57:47,500 - INFO - üèóÔ∏è BLIP3-o ARCHITECTURE FEATURES:
2025-07-28 15:57:47,500 - INFO -   üåê 3D Rotary Position Embedding: ‚úÖ ENABLED
2025-07-28 15:57:47,500 - INFO -   ü•™ Sandwich Normalization: ‚úÖ ENABLED
2025-07-28 15:57:47,500 - INFO -   üîç Grouped-Query Attention: ‚úÖ ENABLED
2025-07-28 15:57:47,500 - INFO -   üìä WandB Logging: ‚ùå DISABLED
2025-07-28 15:57:47,500 - INFO - ================================================================================
2025-07-28 15:57:47,500 - INFO - üéØ DATA CONSISTENCY FEATURES:
2025-07-28 15:57:47,500 - INFO -   üìä Consistent Evaluation: ‚úÖ ENABLED (uses training samples)
2025-07-28 15:57:47,500 - INFO -   üîç Data Validation: ‚úÖ ENABLED
2025-07-28 15:57:47,500 - INFO -   üìà Statistics Logging: ‚úÖ ENABLED
2025-07-28 15:57:47,500 - INFO -   ‚öñÔ∏è Norm Tolerance: 5.0
2025-07-28 15:57:47,500 - INFO -   üìä Evaluation Samples: 100 (from training)
2025-07-28 15:57:47,500 - INFO - ================================================================================
2025-07-28 15:57:47,500 - INFO - Configuration:
2025-07-28 15:57:47,500 - INFO -   Model size: base
2025-07-28 15:57:47,500 - INFO -   Training mode: patch_only
2025-07-28 15:57:47,500 - INFO -   Embeddings dir: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-07-28 15:57:47,500 - INFO -   Output dir: ./checkpoints/clip_repro_20250728_155744
2025-07-28 15:57:47,500 - INFO -   Learning rate: 0.0005
2025-07-28 15:57:47,501 - INFO -   Batch size: 8
2025-07-28 15:57:47,501 - INFO -   Epochs: 10
2025-07-28 15:57:47,501 - INFO -   Max shards: 2
2025-07-28 15:57:47,501 - INFO -   üß™ OVERFITTING TEST: 20 samples
2025-07-28 15:57:47,501 - INFO -   Debug mode: False
2025-07-28 15:57:47,501 - INFO - ================================================================================
2025-07-28 15:57:47,501 - INFO - üîç Validating embeddings directory: /scratch-shared/azadaianchuk1/blip3o_workspace/embeddings/patch_only_256_tokens
2025-07-28 15:57:47,501 - INFO - Found 35 pickle files
2025-07-28 15:57:47,501 - INFO - Analyzing first file: embeddings_shard_00027_patch_only.pkl
2025-07-28 15:57:55,131 - INFO - Keys in first file: ['clip_blip3o_embeddings', 'eva_blip3o_embeddings', 'captions', 'keys', 'total_samples', 'shard_idx', 'source_tar', 'config']
2025-07-28 15:57:55,132 - INFO - CLIP embeddings shape: torch.Size([2588, 256, 1024])
2025-07-28 15:57:55,647 - INFO - üìä CLIP data analysis:
2025-07-28 15:57:55,647 - INFO -    Norm mean: 26.35
2025-07-28 15:57:55,647 - INFO -    Norm std: 2.10
2025-07-28 15:57:55,647 - INFO -    Norm range: [21.91, 36.97]
2025-07-28 15:57:55,647 - INFO -    Samples: 2588
2025-07-28 15:57:55,647 - INFO -    Tokens: 256
2025-07-28 15:57:55,648 - INFO -    Dimensions: 1024
2025-07-28 15:57:55,648 - INFO - EVA embeddings shape: torch.Size([2588, 256, 4096])
2025-07-28 15:57:57,653 - INFO - üìä EVA data analysis:
2025-07-28 15:57:57,653 - INFO -    Norm mean: 43.69
2025-07-28 15:57:57,653 - INFO -    Norm std: 1.94
2025-07-28 15:57:57,653 - INFO -    Norm range: [36.53, 52.39]
2025-07-28 15:57:57,653 - INFO -    Samples: 2588
2025-07-28 15:57:57,653 - INFO -    Tokens: 256
2025-07-28 15:57:57,653 - INFO -    Dimensions: 4096
2025-07-28 15:57:58,124 - INFO - Using GPU: NVIDIA H100
2025-07-28 15:57:58,124 - INFO - GPU Memory: 100.0 GB
2025-07-28 15:57:58,124 - INFO - üèóÔ∏è BLIP3-o Architecture Configuration:
2025-07-28 15:57:58,124 - INFO -   3D Rotary Position Embedding: ‚úÖ Enabled
2025-07-28 15:57:58,124 - INFO -   Sandwich Normalization: ‚úÖ Enabled
2025-07-28 15:58:03,939 - INFO - ‚úÖ CLIP DiT model loaded from src/modules/models/blip3o_dit.py
2025-07-28 15:58:03,943 - INFO - ‚úÖ Flow matching loss loaded from src/modules/losses/blip3o_fm_loss.py
2025-07-28 15:58:05,198 - INFO - ‚úÖ CLIP trainer loaded from src/modules/trainers/blip3o_trainer.py
2025-07-28 15:58:05,210 - INFO - ‚úÖ CLIP datasets loaded from src/modules/datasets/blip3o_dataset.py
2025-07-28 15:58:05,214 - INFO - ‚úÖ Configuration loaded from src/modules/config/blip3o_config.py
2025-07-28 15:58:05,214 - INFO - üéâ All CLIP reproduction components loaded successfully!
2025-07-28 15:58:05,215 - INFO - üéâ BLIP3-o CLIP reproduction modules fully initialized!
2025-07-28 15:58:05,215 - INFO - üö´ Using minimal normalization approach
2025-07-28 15:58:05,215 - INFO - üéØ Ready for EVA ‚Üí CLIP reproduction training
2025-07-28 15:58:05,215 - INFO - ‚úÖ Imported model from src.modules.models.blip3o_dit
2025-07-28 15:58:07,242 - INFO - BLIP3-o CLIP DiT model initialized with 249,339,136 parameters
2025-07-28 15:58:07,242 - INFO -   3D RoPE: True
2025-07-28 15:58:07,242 - INFO -   Sandwich Normalization: True
2025-07-28 15:58:07,242 - INFO -   Grid size: 16x16
2025-07-28 15:58:07,242 - INFO -   Hidden size: 768
2025-07-28 15:58:07,242 - INFO -   CLIP size: 1024
2025-07-28 15:58:07,242 - INFO - Creating base model for patch_only mode...
2025-07-28 15:58:07,487 - INFO - Model created with 249,339,136 parameters
2025-07-28 15:58:07,487 - INFO - Model moved to cuda
2025-07-28 15:58:07,487 - INFO - ‚úÖ Imported loss from src.modules.losses.blip3o_fm_loss
2025-07-28 15:58:07,487 - INFO - CLIP Flow Matching Loss initialized with noise scaling:
2025-07-28 15:58:07,487 - INFO -   Prediction type: velocity
2025-07-28 15:58:07,487 - INFO -   Flow type: rectified
2025-07-28 15:58:07,487 - INFO -   Adaptive noise scaling: True
2025-07-28 15:58:07,487 - INFO -   Debug mode: False
2025-07-28 15:58:07,488 - INFO - Flow matching loss created with adaptive noise scaling
2025-07-28 15:58:07,488 - INFO - üìä Creating dataloaders with CONSISTENT evaluation:
2025-07-28 15:58:07,488 - INFO -   Evaluation samples: 100 (from training data)
2025-07-28 15:58:07,488 - INFO -   Data consistency validation: True
2025-07-28 15:58:07,488 - INFO -   Statistics logging: True
2025-07-28 15:58:07,488 - INFO -   Norm tolerance: 5.0
2025-07-28 15:58:07,488 - INFO - üìä Expected CLIP norm range: (np.float32(16.353588), np.float32(36.35359)) (based on data: 26.35)
2025-07-28 15:58:07,488 - INFO - üìä Expected EVA norm range: (np.float32(28.6904), np.float32(58.6904)) (based on data: 43.69)
2025-07-28 15:58:07,488 - INFO - ‚úÖ Imported dataset from src.modules.datasets.blip3o_dataset
2025-07-28 15:58:07,488 - INFO - Creating CLIP reproduction dataloaders:
2025-07-28 15:58:07,488 - INFO -   Target: CLIP embeddings [B, N, 1024]
2025-07-28 15:58:07,488 - INFO -   Conditioning: EVA embeddings [B, N, 4096]
2025-07-28 15:58:07,488 - INFO -   Normalize: False
2025-07-28 15:58:07,488 - INFO -   üéØ COLLECT STATISTICS: True (for noise scaling)
2025-07-28 15:58:07,488 - ERROR - ‚ùå Training failed with error: BLIP3oCLIPReproductionDataset.__init__() got an unexpected keyword argument 'eval_samples'
